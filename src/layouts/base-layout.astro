---
import { ClientRouter } from 'astro:transitions'
import Footer from '@/components/footer.astro'
import Noise from '@/components/noise.astro'
import SiteHeader from '@/components/site-header.astro'
import { DOMAIN } from '@/constants/site'
import '@unocss/reset/tailwind.css'
import '@/styles/main.css'

interface Props {
  title?: string
  description?: string
  layout?: 'default' | 'wide' | 'fullscreen'
  ogImage?: string
}

const {
  title = 'octohash',
  description = 'Personal website of octohash.',
  layout = 'default',
  ogImage: ogImagePath = '/og.png',
} = Astro.props

const canonical = new URL(Astro.url.pathname, Astro.site || DOMAIN).toString()
const ogImage = new URL(ogImagePath, Astro.site || DOMAIN).toString()
const isWide = layout === 'wide'
const isFullscreen = layout === 'fullscreen'
---

<!doctype html>
<html lang="en">
  <head>
    <script is:inline>
      (() => {
        const storageKey = 'vueuse-color-scheme'
        const media = window.matchMedia('(prefers-color-scheme: dark)')

        function getTheme() {
          const value = localStorage.getItem(storageKey)
          return value === 'dark' || (value !== 'light' && value !== 'dark' && media.matches)
        }

        function updateDark(doc = document, isDark = getTheme()) {
          doc.documentElement.classList.toggle('dark', isDark)
        }

        document.addEventListener('astro:before-swap', (event) => {
          const isDark = document.documentElement.classList.contains('dark')
          // @ts-expect-error Astro transition event provides newDocument at runtime
          event.newDocument?.documentElement?.classList.toggle('dark', isDark)
        })

        document.addEventListener('astro:page-load', () => {
          updateDark()
        })
        updateDark()
      })()
    </script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/png" href="/logo.png" />
    <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml" />
    <meta name="generator" content={Astro.generator} />
    <meta name="description" content={description} />
    <link rel="canonical" href={canonical} />
    <meta property="og:type" content="website" />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:url" content={canonical} />
    <meta property="og:image" content={ogImage} />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImage} />
    <ClientRouter />
    <title>{title}</title>
  </head>
  <body data-layout-mode={layout}>
    <Noise />

    <div class:list={[
      'mx-auto flex flex-col h-screen w-full overflow-hidden',
      isFullscreen ? 'max-w-none' : isWide ? 'max-w-[80rem]' : 'max-w-160',
    ]}
    >
      <SiteHeader overlay={isFullscreen} />

      <main
        transition:name="page"
        transition:animate="slide"
        class:list={[
          'flex-1 min-h-0 w-full',
          isFullscreen ? 'overflow-hidden p-0' : 'overflow-y-auto p-6 lg:p-8',
        ]}
      >
        <div class:list={[
          isFullscreen ? 'h-full' : 'flex flex-col min-h-full',
        ]}
        >
          <div class:list={[isFullscreen ? 'h-full' : 'flex-1']}>
            <slot />
          </div>
          {!isFullscreen && <Footer />}
        </div>
      </main>
    </div>
  </body>
</html>
