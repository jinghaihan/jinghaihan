---
import type { CollectionEntry } from 'astro:content'
import { getCollection } from 'astro:content'
import BaseLayout from '@/layouts/base-layout.astro'
import { formatDate } from '@/utils'

interface PostListItem {
  path: string
  title?: string
  date?: string
  duration?: string
  lang?: string
}

function parseDateTime(date?: string | Date) {
  if (!date)
    return -1

  const value = (date instanceof Date ? date : new Date(date)).getTime()
  return Number.isNaN(value) ? -1 : value
}

const posts = await getCollection('posts')

const sortedPosts = posts
  .slice()
  .sort((a: CollectionEntry<'posts'>, b: CollectionEntry<'posts'>) => parseDateTime(b.data.date) - parseDateTime(a.data.date))

const groupedMap: Record<string, PostListItem[]> = {}
for (const post of sortedPosts) {
  const date = post.data.date ? new Date(post.data.date) : null
  const year = date && !Number.isNaN(date.getTime()) ? date.getFullYear().toString() : 'Unknown'

  if (!groupedMap[year])
    groupedMap[year] = []

  groupedMap[year].push({
    path: `/posts/${post.id}`,
    title: post.data.display || post.data.title || post.id,
    date: typeof post.data.date === 'string'
      ? post.data.date
      : post.data.date?.toISOString(),
    duration: post.data.duration,
    lang: post.data.lang,
  })
}

const groupedPosts = (Object.entries(groupedMap) as [string, PostListItem[]][])
  .map(([year, yearPosts]) => ({
    year,
    posts: yearPosts,
  }))
  .sort((a, b) => {
    if (a.year === 'Unknown')
      return 1
    if (b.year === 'Unknown')
      return -1
    return Number.parseInt(b.year) - Number.parseInt(a.year)
  })
---

<BaseLayout title="Posts - octohash">
  <div>
    <div class="mb-8 flex flex-col items-center">
      <h1 class="text-4xl mb-1">
        Blog
      </h1>
      <p class="text-lg text-muted-foreground/75 italic">
        Gotta write something, I guess.
      </p>
    </div>

    <div class="my-8 flex gap-3 items-center justify-center">
      <a
        href="/algorithm"
        class="group btn-purple"
      >
        <i
          class="i-tabler:binary-tree-2"
        />
        Algorithm
      </a>
      <a
        href="/feed.xml"
        target="_blank"
        class="group btn-lime"
      >
        <i
          class="i-tabler:file-rss group-hover:i-tabler:file-rss-filled"
        />
        RSS Feed
      </a>
    </div>

    {
      groupedPosts.map(group => (
        <div class="mb-8">
          <h2 class="text-xl text-foreground/85 font-semibold mb-4">
            {group.year}
          </h2>
          {
            group.posts.map(post => (
              <div class="mb-3 flex flex-col gap-2 items-baseline lg:flex-row lg:gap-4">
                <div class="text-base text-muted-foreground/80 text-left lg:text-lg">
                  {formatDate(post.date)}
                </div>
                <div>
                  <a
                    href={post.path}
                    class="group text-lg text-foreground/85 no-underline cursor-pointer transition-colors duration-200 hover:text-foreground"
                  >
                    {post.title || 'Untitled'}
                    {post.duration && (
                      <span class="text-sm text-muted-foreground/75 group-hover:text-foreground/85">
                        {' Â· '}
                        {post.duration}
                      </span>
                    )}
                  </a>
                </div>
              </div>
            ))
          }
        </div>
      ))
    }
  </div>
</BaseLayout>
