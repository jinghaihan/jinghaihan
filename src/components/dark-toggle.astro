---
interface Props {
  class?: string
}

const { class: className = '' } = Astro.props
---

<button
  type="button"
  class:list={['cursor-pointer border-none bg-transparent p-0', className]}
  aria-label="Toggle dark mode"
>
  <div
    data-dark-toggle-icon
    class="i-ri:sun-line hover:i-ri:sun-fill dark:i-ri:moon-line hover:dark:i-ri:moon-fill"
  />
</button>

<script is:inline>
  (() => {
    const button = document.currentScript?.previousElementSibling
    if (!(button instanceof HTMLButtonElement))
      return

    const storageKey = 'vueuse-color-scheme'

    function applyDark(isDark) {
      document.documentElement.classList.toggle('dark', isDark)
      localStorage.setItem(storageKey, isDark ? 'dark' : 'light')
    }

    button.addEventListener('click', (event) => {
      // @ts-expect-error experimental API
      const canAnimate = document.startViewTransition
        && !window.matchMedia('(prefers-reduced-motion: reduce)').matches

      const nextIsDark = !document.documentElement.classList.contains('dark')
      if (!canAnimate) {
        applyDark(nextIsDark)
        return
      }

      const pointer = event instanceof MouseEvent
      const x = pointer ? event.clientX : window.innerWidth / 2
      const y = pointer ? event.clientY : window.innerHeight / 2
      const endRadius = Math.hypot(
        Math.max(x, innerWidth - x),
        Math.max(y, innerHeight - y),
      )

      // @ts-expect-error experimental API
      const transition = document.startViewTransition(() => {
        applyDark(nextIsDark)
      })

      transition.ready.then(() => {
        const clipPath = [
          `circle(0px at ${x}px ${y}px)`,
          `circle(${endRadius}px at ${x}px ${y}px)`,
        ]

        document.documentElement.animate(
          {
            clipPath: nextIsDark
              ? [...clipPath].reverse()
              : clipPath,
          },
          {
            duration: 400,
            easing: 'ease-out',
            fill: 'forwards',
            pseudoElement: nextIsDark
              ? '::view-transition-old(root)'
              : '::view-transition-new(root)',
          },
        )
      })
    })
  })()
</script>
